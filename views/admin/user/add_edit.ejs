<div class="page-header">
    <div class="add-item d-flex">
        <div class="page-title">
            <h4 class="fw-bold">Admin List</h4>
            <h6>(<span class='mandadory'>*</span>) indicates required field.</h6>
        </div>
    </div>
    <div class="page-btn mt-0">
        <a href="/admin/users" class="btn btn-secondary" id="backBtn"><i data-feather="arrow-left" class="me-2"></i>Back to Admin List</a>
    </div>
</div>
<form action="<%= admin ? '/admin/users/update/' + helpers.encryptId(admin.id) : '/admin/users/store' %>" method="POST" enctype="multipart/form-data" id="mainForm">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title"><%= admin ? 'Edit' : 'New' %> Admin</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label class="form-label">Name<span class='mandadory'>*</span></label>
                                <input type="text" class="form-control" name="name" id="name" placeholder="Enter name" value="<%= admin ? admin.name : '' %>" autofocus />
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label class="form-label">Email<span class='mandadory'>*</span></label>
                                <input type="email" class="form-control" name="email" id="email" placeholder="Enter email" value="<%= admin ? admin.email : '' %>" />
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label class="form-label">Mobile No.<span class='mandadory'>*</span></label>
                                <input type="number" class="form-control" name="mobile_no" id="mobile_no" placeholder="Enter mobile no."  value="<%= admin ? admin.mobile_no : '' %>" />
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label class="form-label">Password<span class='mandadory'>*</span></label>
                                <input type="password" class="form-control" name="password" id="password" placeholder="Enter password" />
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label class="form-label">Status</label>
                                <select class="select" name="isActive" id="isActive">
                                    <option value="1" <%= admin && admin.isActive == 1 ? 'selected' : '' %>>Active</option>
                                    <option value="0" <%= admin && admin.isActive == 0 ? 'selected' : '' %>>Inactive</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="text-end">
                        <button type="reset" class="btn btn-primary">Clear</button>
                        <button type="submit" class="btn btn-secondary">Submit</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">New User</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table" id="permissionTbl">
                            <thead>
                                <tr>
                                    <th>Module</th>
                                    <th>Full Access</th>
                                    <th>Add</th>
                                    <th>Edit</th>
                                    <th>List</th>
                                    <th>Delete</th>
                                    <th>Export</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
<script>
    var page_title = "Admin List";
    const existingPermissions = <%- admin && admin.permission ? admin.permission : '{}' %>;
    $(document).ready(function(){
        var html = "";
        $("li.permission").each(function(){
            let module_title = $(this).attr("data-title");
            let module_name = $(this).attr("data-module");

            const modulePerm = existingPermissions[module_name] || {};

            html += '<tr>';
            html += '<td>'+module_title+'</td>';
            html += '<td class="py-3"><div class="form-check form-check-md"><input class="form-check-input full" type="checkbox" name="permissions['+module_name+'][full]" value="1" ' + (modulePerm.full == '1' ? 'checked' : '') + ' /></div></td>';
            html += '<td class="py-3"><div class="form-check form-check-md"><input class="form-check-input add" type="checkbox" name="permissions['+module_name+'][add]" value="1" ' + (modulePerm.add == '1' ? 'checked' : '') + ' /></div></td>';
            html += '<td class="py-3"><div class="form-check form-check-md"><input class="form-check-input edit" type="checkbox" name="permissions['+module_name+'][edit]" value="1" ' + (modulePerm.edit == '1' ? 'checked' : '') + ' /></div></td>';
            html += '<td class="py-3"><div class="form-check form-check-md"><input class="form-check-input list" type="checkbox" name="permissions['+module_name+'][list]" value="1" ' + (modulePerm.list == '1' ? 'checked' : '') + ' /></div></td>';
            html += '<td class="py-3"><div class="form-check form-check-md"><input class="form-check-input delete" type="checkbox" name="permissions['+module_name+'][delete]" value="1" ' + (modulePerm.delete == '1' ? 'checked' : '') + ' /></div></td>';
            html += '<td class="py-3"><div class="form-check form-check-md"><input class="form-check-input export" type="checkbox" name="permissions['+module_name+'][export]" value="1" ' + (modulePerm.export == '1' ? 'checked' : '') + ' /></div></td>';
            html += '</tr>';    
        });
        $("#permissionTbl tbody").html(html);
        $(".full").click(function(){
            if($(this).prop("checked") == true) {
                $(this).parents("tr").find(".add").prop("checked",true);
                $(this).parents("tr").find(".edit").prop("checked",true);
                $(this).parents("tr").find(".list").prop("checked",true);
                $(this).parents("tr").find(".delete").prop("checked",true);
                $(this).parents("tr").find(".export").prop("checked",true);
            } else {
                $(this).parents("tr").find(".add").prop("checked",false);
                $(this).parents("tr").find(".edit").prop("checked",false);
                $(this).parents("tr").find(".list").prop("checked",false);
                $(this).parents("tr").find(".delete").prop("checked",false);
                $(this).parents("tr").find(".export").prop("checked",false);
            }
        });
        $(".add, .edit, .list, .delete, .export").click(function() {
            is_all_checked($(this));
        });

        $("#mainForm").submit(function(e){
            e.preventDefault();

            $.ajax({
                url: $("#mainForm").attr("action"),
                type: $("#mainForm").attr("method"),
                data: new FormData(this),
                processData: false,
                contentType: false,
                cache: false,
                beforeSend:function(){
                    $("#mainForm button[type=submit]").html("Submitting...").attr("disabled",true);
                },
                success:function(response){
                    if(response.success) {
                        show_toast("Success!",response.message,"success");
                        setTimeout(function(){
                            window.location.href = $("#backBtn").attr("href");
                        },3000);
                    }
                },
                error: function(xhr, status, error) {
                    $("#mainForm button[type=submit]").html("Submit").attr("disabled",false);
                    if (xhr.status === 400) {
                        const res = xhr.responseJSON;
                        show_toast("Oops!",res.message,"error");
                    } else {
                        show_toast("Oops!","Something went wrong","error");
                    }
                }
            });
        });
    });
    function is_all_checked(obj)
    {
        var row = obj.closest("tr"); 
        var isAllChecked = row.find(".add").prop("checked") && row.find(".edit").prop("checked") && row.find(".list").prop("checked") && row.find(".delete").prop("checked") && row.find(".export").prop("checked");
        row.find(".full").prop("checked", isAllChecked);
    }
</script>